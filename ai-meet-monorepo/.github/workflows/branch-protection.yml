name: Configure Branch Protection

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write
  administration: write

jobs:
  set-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Set branch protection for main and develop
        uses: actions/github-script@v7
        with:
          script: |
            const branches = ['main', 'develop'];
            for (const branch of branches) {
              try {
                await github.rest.repos.updateBranchProtection({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch,
                  required_status_checks: {
                    strict: true,
                    contexts: ['CI Pipeline']
                  },
                  enforce_admins: false,
                  required_pull_request_reviews: {
                    required_approving_review_count: 1
                  },
                  restrictions: null,
                  required_linear_history: true,
                  allow_force_pushes: false,
                  allow_deletions: false,
                  required_conversation_resolution: true
                });
                core.info(`Protection applied to ${branch}`);
              } catch (err) {
                core.warning(`Failed to set protection on ${branch}: ${err}`);
              }
            }
