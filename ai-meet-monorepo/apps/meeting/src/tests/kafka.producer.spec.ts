import { Test, TestingModule } from "@nestjs/testing"; import { KafkaService, EventTopics } from "@aimeet/kafka"; describe("Kafka Producer Unit Test", () => { let kafkaService: KafkaService; let module: TestingModule; const mockKafkaService = { onModuleInit: jest.fn(), onModuleDestroy: jest.fn(), publishEvent: jest.fn().mockResolvedValue({ success: true }), subscribeToTopic: jest.fn(), }; beforeAll(async () => { module = await Test.createTestingModule({ providers: [{ provide: KafkaService, useValue: mockKafkaService, }], }).compile(); kafkaService = module.get<KafkaService>(KafkaService); }); afterAll(async () => { if (module) { await module.close(); } }); describe("Producer Functionality", () => { it("should publish events successfully", async () => { const testEventData = { meetingId: "test-meeting-123", title: "Test Meeting", tenantId: "tenant-123", }; const result = await kafkaService.publishEvent("meeting.created" as EventTopics, testEventData); expect(mockKafkaService.publishEvent).toHaveBeenCalledWith("meeting.created", testEventData); expect(result).toEqual({ success: true }); }); it("should handle event publishing errors gracefully", async () => { const errorMessage = "Failed to publish event"; mockKafkaService.publishEvent.mockRejectedValueOnce(new Error(errorMessage)); const testEventData = { meetingId: "test-meeting-123" }; await expect(kafkaService.publishEvent("meeting.ended" as EventTopics, testEventData)).rejects.toThrow(errorMessage); }); }); });
